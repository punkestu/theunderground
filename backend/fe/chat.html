<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.7.0.js"
            integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
</head>
<body style="margin: 0;">
<div style="height: 100vh;">
    <div style="height: 10vh; background-color: white; padding: 0.5rem">
        <h1 style="margin: 0">PUBLIC ID : <span id="pub"></span></h1>
        <form enctype="multipart/form-data" id="form">
            <input type="file" name="key" id="key">
            <button>Login</button>
        </form>
        <div id="recipient-form" style="display: none">
            <label for="recipient">recipient</label><input type="text" name="recipient" id="recipient">
        </div>
    </div>
    <div style="height: calc(85vh - 3rem); overflow-y: scroll; background-color: black; color: white; padding: 0 2rem" id="chats"></div>
    <form id="chat-form" style="height: 5vh; padding: 0.5rem; display: flex">
        <textarea name="chat" id="chat" rows="1"
                  style="border: 2px solid black; width: 100%; padding: 0.5rem; resize: none"></textarea>
        <button type="submit">Send</button>
    </form>
</div>
</body>
<script>
    $("#form").on("submit", function (e) {
        e.preventDefault();
        const fileupload = $('#key').prop('files')[0];
        const formData = new FormData();
        formData.append('key', fileupload);
        $.ajax({
            type: 'POST',
            url: "/",
            data: formData,
            cache: false,
            processData: false,
            contentType: false,
            success: main,
            error: function () {
                alert("failed to login");
            }
        });
        document.getElementById("form").reset();
    });
</script>
<script src="/js/encrypt.js"></script>
<script src="/js/decrypt.js"></script>
<script src="/js/pushChat.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    function main(msg) {
        const t_public = msg.publictoken;
        const t_private = msg.privatetoken;
        const sw = msg.switcher.toString();
        $("#pub").text(msg.publictoken);
        $("#form").remove();
        $("#recipient-form").show();
        $("#chat-form").submit(function (e) {
            e.preventDefault();
            const chat = $("#chat");
            const r_public = $("#recipient").val();
            if (chat.val().length > 0 && r_public.length > 0) {
                socket.emit("chat", {chat: encrypt({chat: chat.val(), sw}), token: t_public, recipient: r_public});
                $("#chats").append(`<p>To :${chat.val()}</p>`)
                chat.val("");
            }
        });
        socket.on(t_private, (data) => {
            pushChat(decrypt({chat: data.chat, sw}));
        });
    }
</script>
</html>